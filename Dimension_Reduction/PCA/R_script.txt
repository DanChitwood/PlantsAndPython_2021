#Reshaping the expression data and metadata
#Based on Sof√≠a Zorrilla's R script 

#Preparing hpcc to use R interactively loading required modules
module purge
module load GCC/8.3.0
module load OpenMPI/3.1.4
module load R/4.0.2 

#Opening R in the hpcc after loading the module
R

#Loading the R package data.table to work with large datasets
library("data.table")
#Reading the expression data for arabidopsis
data = fread("/mnt/research/HRT841_F21/Class_project/Arabidopsis_expression_matrix/DataClean/MapRateFiltered_v1.csv", showProgress=T)
#Separating the columns that contain the metadata
metadata = data[,1:10]

#Converting the metadata columns to a dataframe
metadata_df = as.data.frame(metadata)

#Reading the categories for tissue generated by group 1 and 2
cat = read.csv("/mnt/home/f0103229/Test_project/categories.csv",header = T)

#Loading the tidyverse package
library(tidyverse) #/tmp/RtmpSjEx0o/downloaded_packages

#Renaming the Tissue/RawName column to Tissue_raw in the cat data and the metadata dataframe 
names(metadata_df)[names(metadata_df)=="Tissue"] = "Tissue_raw"
names(cat)[names(cat)=="RawName"] = "Tissue_raw"

#Joining the classification columns to the metadata
metadata_cat = left_join(metadata_df,cat,by = "Tissue_raw")

#Changing from dataframe to table
metadata_table = as.data.table(metadata_cat) # this is because the data.table package works with data.table objects not data.frames

#Joining the metadata to the whole dataset
data_all = metadata_table[data, on= .(Sample)]

#Stating the repeated columns
not_keep_names = c("i.Project", "i.SampleName","i.PMID","i.Genotype","i.Ecotype","i.Tissue","i.TotalReads","i.UniqueMappedRate", "i.ReleaseDate")

#Taking out the repeated columns
filt_data = data_all[,!colnames(data_all) %in% not_keep_names, with = FALSE]

#Changing the labels of tissues not considered in categories as other
filt_data[which(is.na(filt_data[["Tissue"]])),"Tissue"]= "other"

filt_data[which(is.na(filt_data[["VegetativeRepro"]])),"VegetativeRepro"]= "other"

filt_data[which(is.na(filt_data[["AboveBelow"]])),"AboveBelow"]= "other"

#Writing file with the metadata
fwrite(filt_data[,1:14], "meta_filt_data_cat.csv")
#Writing file with the expression counts
fwrite(filt_data[,15:ncol(filt_data)], "num_filt_data_cat.csv")

